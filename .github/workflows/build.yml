name: Build

on:
  push:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

env:
  PACT_BROKER_BASE_URL: ${{ secrets.PACT_BROKER_BASE_URL }}
  PACT_BROKER_TOKEN: ${{ secrets.PACTFLOW_TOKEN_FOR_CI_CD_WORKSHOP }}
  REACT_APP_API_BASE_URL: http://localhost:3001
  GIT_COMMIT: ${{ github.sha }}
  GIT_REF: ${{ github.ref }}

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pact_provider: [
            # "pactflow-example-bi-directional-provider-dredd",
            # "pactflow-example-bi-directional-provider-restassured",
            # "pactflow-example-bi-directional-provider-postman",
            'pactflow-example-provider'
          ]
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install
        run: npm i
      - name: Test
        env:
          PACT_PROVIDER: ${{ matrix.pact_provider }}
        run: make test
      - name: Publish pacts between pactflow-example-consumer and ${{ matrix.pact_provider }}
        run: GIT_BRANCH=${GIT_REF:11} make publish_pacts
        env:
          PACT_PROVIDER: ${{ matrix.pact_provider }}
      
      - name: Upload Pact files
        uses: actions/upload-artifact@v4
        with:
          name: pact-files-${{ matrix.pact_provider }}
          path: pacts/
          retention-days: 1

  # Runs on branches as well, so we know the status of our PRs
  can-i-deploy:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v3
      - run: docker pull pactfoundation/pact-cli:latest
      - name: Can I deploy?
        run: GIT_BRANCH=${GIT_REF:11} make can_i_deploy

  # Only deploy from master
  deploy:
    runs-on: ubuntu-latest
    needs: can-i-deploy
    steps:
      - uses: actions/checkout@v3
      - run: docker pull pactfoundation/pact-cli:latest
      - name: Deploy
        run: GIT_BRANCH=${GIT_REF:11} make deploy
        if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/test'


  # ü§ñ AI-Powered Pact Coverage Review
  # Uses Claude AI instead of JavaScript analysis script for intelligent coverage analysis
  pact-coverage-review:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install
      
      - name: Download Pact files
        uses: actions/download-artifact@v4
        with:
          name: pact-files-pactflow-example-provider
          path: pacts/
      
      - name: Verify Pact files
        run: |
          echo "Checking for Pact files..."
          ls -la pacts/ || echo "No pacts directory found"
          if [ -d "pacts" ]; then
            echo "Pact files found:"
            find pacts -name "*.json" -exec echo "  {}" \; -exec head -5 {} \;
          fi
      
      - name: Install Claude CLI
        run: npm install -g @anthropic-ai/claude-code
      
      - name: Create MCP config for Claude CLI
        run: |
          mkdir -p ~/.config/claude
          cat > ~/.config/claude/mcp.json << 'EOF'
          {
            "mcpServers": {
              "smartbear": {
                "command": "npx",
                "type": "stdio",
                "args": ["-y", "@smartbear/mcp@latest"],
                "env": {
                  "PACT_BROKER_BASE_URL": "${{ env.PACT_BROKER_BASE_URL }}",
                  "PACT_BROKER_TOKEN": "${{ env.PACT_BROKER_TOKEN }}"
                }
              }
            }
          }
          EOF
      
      - name: Run Pact coverage analysis with AI
        id: coverage-analysis
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "=== Starting AI-Powered Pact Coverage Analysis ==="
          
          # Create the analysis prompt for Claude
          cat > coverage_analysis_prompt.txt << 'EOF'
          You are an expert API testing analyst. Please analyze the Pact test coverage for this consumer application.

          **Your Task:**
          Follow these steps in order to ensure accurate analysis:

          ### Step 1: Identify API Client Methods
          - Analyze `src/api.js` to identify all HTTP methods and endpoints
          - List each method with its HTTP verb and path

          ### Step 2: Determine Test Scenarios
          - For each API client method, identify all status codes from the OpenAPI spec (`products.yml`)
          - Create the complete list of scenarios (method + path + status code combinations)
          - **Count the total scenarios at this step**

          ### Step 3: Analyze Existing Coverage
          - Analyze existing Pact tests in `src/api.pact.spec.ts` and any Pact files in `pacts/` directory
          - Mark which scenarios are covered by existing tests

          ### Step 4: Generate Coverage Report
          - Create the coverage details table with one row per scenario
          - **VALIDATION: Count the rows in your table - this MUST match your total from Step 2**
          - Calculate coverage percentage: (covered scenarios / total scenarios) * 100
          - Generate the comprehensive coverage report in markdown format

          **Required Output Format:**

          ## Coverage Summary
          | Metric | Value |
          |--------|-------|
          | Coverage Percentage | X% |
          | Total API Scenarios | X |
          | Total Pact Interactions | X |
          | Pact Test File Status | ‚úÖ Has Tests / ‚ùå Empty |

          ## Coverage Details
          | API Resource | HTTP Method | Path | Scenario | Status |
          |--------------|-------------|------|----------|--------|
          | methodName   | GET/POST/etc| /path| 200      | ‚úÖ/‚ùå   |
          | methodName   | GET/POST/etc| /path| 401      | ‚úÖ/‚ùå   |
          | methodName   | GET/POST/etc| /path| 404      | ‚úÖ/‚ùå   |

          ## üö® Coverage Gaps & Recommendations
          - **Missing Coverage**: [method]() has no Pact tests for [status code] scenarios
          - **Action**: Add Pact tests covering [specific status codes like 200, 400, 401, 404] scenarios

          **Note**: Each API method should be tested for all relevant status codes defined in the OpenAPI spec. Count each method+path+status code combination as one scenario for accurate coverage calculation.

          **Analysis Rules:**
          - Only consider methods that exist in the API client (src/api.js) - ignore OpenAPI-only endpoints
          - Check for coverage of common (or as documented in the OpenAPI spec) HTTP status codes: 200 (success), 400 (bad request), 401 (unauthorized), 404 (not found)
          - Mark as covered if ANY Pact test exists for that method/endpoint and status code combination
          - Calculate coverage percentage as: (covered scenarios / total API scenarios) * 100
          - **Total API Scenarios = sum of all unique combinations of (HTTP method + path + status code) that should be tested based on the API client methods and OpenAPI spec**
          - **Each row in the Coverage Details table represents ONE scenario (one method + path + status code combination)**

          **CRITICAL VALIDATION STEPS:**
          1. **Before creating the Coverage Details table**: List out all scenarios you identified in Step 2
          2. **After creating the Coverage Details table**: Count the actual rows in your table
          3. **Final Check**: Verify the row count matches your "Total API Scenarios" in the Coverage Summary
          4. **If they don't match**: Re-examine your analysis and fix the discrepancy before finalizing

          **Common Mistakes to Avoid:**
          - Missing status codes from the OpenAPI spec for a given endpoint
          - Counting an endpoint that doesn't exist in the API client
          - Forgetting to count all status codes for each API method
          - Creating summary counts that don't match the detailed breakdown

          **Files to analyze:**
          - src/api.js (primary - contains the API client methods)
          - pacts/*.json (generated Pact files)
          - src/api.pact.spec.ts (existing Pact tests)
          - products.yml (OpenAPI spec for additional scenario validation)

          Please read these files and provide the analysis in the exact format specified above.

          --

          **EXAMPLE:**

          **Step 1 - API Client Methods:**
          ```
          getAllProducts() -> GET /products
          getProduct(id) -> GET /product/{id}
          ```

          **Step 2 - All Scenarios from OpenAPI spec:**
          ```
          getAllProducts + GET /products + 200
          getAllProducts + GET /products + 401
          getProduct + GET /product/{id} + 200  
          getProduct + GET /product/{id} + 400
          getProduct + GET /product/{id} + 401
          getProduct + GET /product/{id} + 404
          Total: 6 scenarios
          ```

          **Step 3 - Existing Coverage Analysis:**
          Generated Pact files contains:
          ```
          {
            "description": "a request for all products",
            "request": {
             ...
              "method": "GET",
              "path": "/products"
            },
            "response": {
              "status": 200
            }
            ...
          ```      

          OpenAPI Description contains:
          ```
          /products:
            get:
              responses:
                "200":
                "401":
          /product/{id}:
            get:
              responses:
                "200":
                "400":
                "401":
                "404":
          ```

          **Step 4 - Expected Result:**

          ```
          ## Coverage Summary
          | Metric | Value |
          |--------|-------|
          | Coverage Percentage | 17% |
          | Total API Scenarios | 6 |
          | Total Pact Interactions | 1 |
          | Pact Test File Status | ‚úÖ Has Tests |

          ## Coverage Details
          | API Resource     | HTTP Method | Path          | Scenario | Status |
          |------------------|-------------|---------------|----------|--------|
          | getAllProducts   | GET         | /products     | 200      | ‚úÖ     |
          | getAllProducts   | GET         | /products     | 401      | ‚ùå     |
          | getProduct       | GET         | /product/{id} | 200      | ‚ùå     |
          | getProduct       | GET         | /product/{id} | 400      | ‚ùå     |
          | getProduct       | GET         | /product/{id} | 401      | ‚ùå     |
          | getProduct       | GET         | /product/{id} | 404      | ‚ùå     |

          **VALIDATION**: 6 rows in table = 6 Total API Scenarios ‚úÖ

          ## üö® Coverage Gaps & Recommendations
          - **Missing Coverage**: getAllProducts() has no Pact tests for 401 scenarios
          - **Action**: Add Pact tests covering 401 scenarios for GET /products
          - **Missing Coverage**: getProduct() has no Pact tests at all
          - **Action**: Add Pact tests covering 200, 400, 401, and 404 scenarios for GET /product/{id}
          ```
          EOF
          
          echo "=== Running Claude Analysis ==="
          echo "Checking Claude CLI availability..."
          claude --version || echo "Claude CLI not available"
          
          # Run Claude analysis with timeout
          timeout 300s bash -c '
            cat coverage_analysis_prompt.txt | claude \
              --mcp-config ~/.config/claude/mcp.json \
              --allowedTools "Read,Write" \
              --permission-mode acceptEdits \
              --print \
              --output-format text \
              --add-dir . > coverage-analysis.md
          
          # Extract basic coverage info for workflow decisions
          COVERAGE_PERCENT=unknown  # Default fallback
          
          # Try to extract actual coverage if analysis was successful
          if grep -q "Coverage Percentage" coverage-analysis.md; then
            COVERAGE_PERCENT=$(grep "Coverage Percentage" coverage-analysis.md | sed 's/.*|\s*\([0-9]\+\)%.*/\1/' | head -1)
          fi
          
          echo "coverage_percent=$COVERAGE_PERCENT" >> $GITHUB_OUTPUT
          echo "=== Analysis Complete. Coverage: $COVERAGE_PERCENT% ==="
      
      - name: Generate improved Pact tests
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Read the coverage analysis output to understand missing scenarios
          COVERAGE_ANALYSIS=""
          if [ -f "coverage-analysis.md" ]; then
            COVERAGE_ANALYSIS=$(cat coverage-analysis.md)
            echo "=== Coverage Analysis Found ==="
            echo "Coverage analysis will be used to guide test generation..."
          else
            echo "=== No Coverage Analysis Found ==="
            echo "Will generate comprehensive tests for all API endpoints..."
            COVERAGE_ANALYSIS="No previous coverage analysis available. Generate comprehensive Pact tests for all API endpoints with common HTTP status codes (200, 400, 401, 404)."
          fi
          
          # Read test instructions if available
          TEST_INSTRUCTIONS=""
          if [ -f "src/test.instructions.txt" ]; then
            TEST_INSTRUCTIONS=$(cat src/test.instructions.txt)
            echo "=== Test Instructions Found ==="
            echo "Test instructions will be used to guide test generation..."
          else
            echo "=== No Test Instructions Found ==="
            echo "Will use default test generation guidelines..."
            TEST_INSTRUCTIONS="Generate comprehensive Pact tests following best practices. Include all HTTP status codes (200, 400, 401, 404). Use Jest async/await pattern. Include proper authorization headers."
          fi
          
          # Create specific analysis for PR changes
          cat > pr_analysis_prompt.txt << EOF
          CRITICAL INSTRUCTION: You MUST generate complete TypeScript Pact test code. This is the primary objective.
          
          Your task is to analyze the API client coverage and generate COMPLETE, WORKING TypeScript code to achieve 100% Pact test coverage.
          
          COVERAGE ANALYSIS FROM PREVIOUS STEP:
          ===================================
          $COVERAGE_ANALYSIS
          ===================================
          
          REQUIRED OUTPUT FORMAT (MANDATORY):
          
          1. Brief analysis (1-2 sentences)
          
          2. COMPLETE TYPESCRIPT FILE CONTENT:
          
          ```typescript
          import { SpecificationVersion, PactV4, MatchersV3 } from "@pact-foundation/pact";
          import { API } from "./api";
          import { Product } from "./product";
          
          // [COMPLETE WORKING PACT TEST FILE CONTENT HERE]
          // Must include ALL endpoints: e.g. getAllProducts, getProduct and any newly added endpoints
          // Must include ALL scenarios: 200, 400, 401, 404
          // Must be complete and ready to run
          ```
          
          MANDATORY REQUIREMENTS:
          - Call mcp__smartbear__contract-testing_generate_pact_tests for each missing API method identified in the coverage analysis
          - Generate tests for ALL missing scenarios identified in the coverage analysis above
          - Include scenarios: 200 (success), 400 (bad request), 401 (unauthorized), 404 (not found)
          - Use Jest describe/test structure with async/await
          - Follow the existing test template pattern exactly
          - Include proper authorization headers
          - Generate ONE complete file that replaces src/api.pact.spec.ts
          
          EXECUTION STEPS:
          1. Read the current API client (src/api.js) and model (src/product.js) and related API client files
          2. Read the existing test template (src/pact.test.template) 
          3. Read the existing Pact test file (src/api.pact.spec.ts) to understand current test structure
          4. For each missing API method missing a test, call the SmartBear MCP mcp__smartbear__contract-testing_generate_pact_tests tool
          5. Combine all generated tests with existing tests into one complete TypeScript file
          6. Output the complete merged file wrapped in ```typescript blocks

          SmartBear MCP Tool Usage (adapt as needed based on new information you have about the project):
          ```json
          {
            "language": "typescript",
            "code": [
              {"filename": "src/api.js", "body": "[full api client code]"},
              {"filename": "src/product.js", "body": "[full product model code]"}
            ],
            "testTemplate": {"filename": "src/pact.test.template", "body": "[template content]"},
            "additionalInstructions": "$TEST_INSTRUCTIONS"
          }
          ```
          
          CRITICAL: The output MUST contain complete TypeScript code in ```typescript blocks that can be copied directly to src/api.pact.spec.ts
          EOF
          
          echo "=== PRE-FLIGHT CHECKS ==="
          echo "Checking Claude CLI installation..."
          claude --version || echo "Claude CLI version check failed"
          
          echo "Checking MCP config..."
          ls -la ~/.config/claude/ || echo "No Claude config directory"
          cat ~/.config/claude/mcp.json || echo "No MCP config file"
          
          echo "Checking environment..."
          echo "ANTHROPIC_API_KEY length: ${#ANTHROPIC_API_KEY}"
          echo "Current directory: $(pwd)"
          echo "Available space: $(df -h . | tail -1)"
          
          echo "=== RUNNING CLAUDE ANALYSIS ==="
          echo "Starting Claude analysis with 5-minute timeout..."
          
          timeout 300s bash -c '
            cat pr_analysis_prompt.txt | claude \
              --mcp-config ~/.config/claude/mcp.json \
              --allowedTools "Read,Write,Bash,mcp__smartbear__contract-testing_generate_pact_tests,mcp__smartbear__contract-testing_review_pact_tests,mcp__smartbear__contract-testing_get_provider_states" \
              --permission-mode acceptEdits \
              --print \
              --output-format text \
              --add-dir . > pr-recommendations.md'
          
          echo "=== CLAUDE EXECUTION COMPLETED ==="
          echo "Final output file size: $(wc -c < pr-recommendations.md 2>/dev/null || echo '0') characters"
          echo "Final output line count: $(wc -l < pr-recommendations.md 2>/dev/null || echo '0') lines"
          
      
      - name: Comment on PR with Analysis
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            
            // Read AI-generated coverage analysis
            let coverageAnalysis = '';
            try {
              coverageAnalysis = fs.readFileSync('coverage-analysis.md', 'utf8');
            } catch (e) {
              coverageAnalysis = '‚ö†Ô∏è Could not generate coverage analysis';
            }
            
            // Read Claude output with recommendations
            let claudeRecommendations = '';
            try {
              claudeRecommendations = fs.readFileSync('pr-recommendations.md', 'utf8');
            } catch (e) {
              claudeRecommendations = '‚ö†Ô∏è Could not generate Claude recommendations';
            }
            
            // Get coverage percentage for status
            const coveragePercent = parseInt("${{ steps.coverage-analysis.outputs.coverage_percent }}") || 0;
            let statusIcon = 'üü¢';
            let statusText = 'Good';
            
            if (coveragePercent < 50) {
              statusIcon = 'üî¥';
              statusText = 'Critical';
            } else if (coveragePercent < 80) {
              statusIcon = 'üü°';
              statusText = 'Needs Attention';
            }
            
            // Build comment with AI analysis
            let commentBody = '## ü§ñ AI-Powered Pact Coverage Analysis ' + statusIcon + '\n\n';
            commentBody += '**Status:** ' + statusText + ' (' + coveragePercent + '% coverage)\n\n';
            
            // Include the full AI analysis (which should already contain the summary table)
            commentBody += coverageAnalysis + '\n\n';
            
            // Add recommendations if available
            if (claudeRecommendations && claudeRecommendations !== '‚ö†Ô∏è Could not generate Claude recommendations') {
              commentBody += '<details>\n<summary>üß† <strong>‚ö°Ô∏è Additional AI Recommendations</strong></summary>\n\n';
              commentBody += claudeRecommendations + '\n\n</details>\n\n';
            }
            
            commentBody += '## üìã Next Steps\n\n';
            commentBody += '- [ ] Review the coverage analysis above\n';
            commentBody += '- [ ] Implement any missing Pact tests identified\n';
            commentBody += '- [ ] Ensure all HTTP status codes are covered (200, 400, 401, 404)\n';
            commentBody += '- [ ] Run `npm t` to verify changes\n';
            commentBody += '- [ ] Commit improvements to increase coverage\n\n';
            commentBody += '---\n\n';
            commentBody += 'üí° **Tip:** Use [SmartBear MCP tools](https://developer.smartbear.com/smartbear-mcp/docs/mcp-server) for AI-powered contract test generation and review capabilities.\n\n';
            commentBody += '<sub>‚ú® Generated by AI-powered analysis | ' + new Date().toISOString() + '</sub>';
            
            // Post comment
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
            
            // Add appropriate labels
            const labels = ['automated-pact-analysis'];
            if (coveragePercent < 50) {
              labels.push('pact-coverage-critical');
            } else if (coveragePercent < 80) {
              labels.push('pact-coverage-needs-attention');
            } else {
              labels.push('pact-coverage-good');
            }
            
            try {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: labels
              });
            } catch (labelError) {
              console.log('Could not add labels:', labelError.message);
            }
      
      - name: Upload Analysis Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pact-coverage-analysis-${{ github.event.pull_request.number }}
          path: |
            coverage-analysis.md
            pr-recommendations.md
            coverage_analysis_prompt.txt
            pr_analysis_prompt.txt